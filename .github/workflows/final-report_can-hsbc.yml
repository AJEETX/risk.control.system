name: Build and deploy ASP.Net Core app to Azure Web App - can-hsbc

on:
  push:
    branches:
      - final-report
  workflow_dispatch:

permissions:
  id-token: write
  contents: read
  security-events: write

env:
  APP_SERVICE_NAME: "can-hsbc"

jobs:

  # ---------------------------------------------------
  # 1️⃣ Code Scan Job
  # ---------------------------------------------------
  code-scan:
    uses: ./.github/workflows/code-scan.yml
    secrets: inherit

  # ---------------------------------------------------
  # 2️⃣   Build  .Net Core Application Job
  # ---------------------------------------------------
  build:
    name: Build .Net Core Application
    runs-on: windows-latest
    needs: code-scan
    permissions:
      contents: read #This is required for actions/checkout

    steps:
      - uses: actions/checkout@v4

      - name: Set up .NET Core
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.x'

      - name: Build with dotnet
        run: dotnet build --configuration Release

      - name: dotnet publish
        run: dotnet publish -c Release -o "${{env.DOTNET_ROOT}}/myapp"

      - name: Upload artifact for deployment job
        uses: actions/upload-artifact@v4
        with:
          name: .net-app
          path: ${{env.DOTNET_ROOT}}/myapp

      - name: Add Summary Output
        run: |
            echo "## Build Completed" >> $GITHUB_STEP_SUMMARY
            echo "The .NET application has been built and published successfully." >> $GITHUB_STEP_SUMMARY

 # ---------------------------------------------------
  # 3️⃣ Deploy to Azure Job
  # ---------------------------------------------------
  deploy:
    name: Deploy to Azure Web App
    runs-on: windows-latest
    needs: build
    
    steps:
      - name: Download artifact from build job
        uses: actions/download-artifact@v4
        with:
          name: .net-app
      
      - name: Deploy to Azure Web App
        id: deploy-to-webapp
        uses: azure/webapps-deploy@v3
        with:
          app-name: 'can-hsbc'
          slot-name: 'Production'
          package: .
          publish-profile: ${{ secrets.AZUREAPPSERVICE_PUBLISHPROFILE_243D92813C17446F8D6FDDFB931F0A80 }}
 
      - name: Add Deployment Summary Output
        run: |
            echo "## Deployment Completed" >> $GITHUB_STEP_SUMMARY
            echo "The application has been deployed to Azure Web App successfully." >> $GITHUB_STEP_SUMMARY

# ---------------------------------------------------
  # 4️⃣ Warmup Job
  # ---------------------------------------------------
  warmup:
    name: Warm Up Azure Web App
    runs-on: ubuntu-latest
    needs: deploy

    steps:
    - name: Wait for App Service warmup
      shell: bash
      run: |
        echo "🌐 Waiting for App Service to be ready..."
        URL="https://${{ env.APP_SERVICE_NAME }}.azurewebsites.net/Account/Login"

        for i in {1..20}; do
          STATUS=$(curl -o /dev/null -s -w "%{http_code}\n" "$URL" || echo 000)

          echo "Attempt $i → Status: $STATUS"

          if [ "$STATUS" -eq 200 ] || [ "$STATUS" -eq 302 ]; then
            echo "✅ App is ready!"
            exit 0
          fi

          echo "⏳ Not ready, waiting 15s..."
          sleep 15
        done

        echo "❌ App did NOT become ready in time."
        exit 1

    - name: Add Warm-up Summary Output
      if: always()
      run: |
        echo "## App Service Warmup Completed" >> $GITHUB_STEP_SUMMARY
        echo "The Azure Web App warm-up job has finished." >> $GITHUB_STEP_SUMMARY

# ---------------------------------------------------
  # 5️⃣ OWASP ZAP Baseline Scan Job
  # ---------------------------------------------------
  zap-scan:
    name: OWASP ZAP Baseline Scan
    needs: warmup
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Fix permissions
        run: sudo chmod -R 777 $GITHUB_WORKSPACE

      - name: Run ZAP Baseline (Direct Docker)
        run: |
          docker run --network=host \
            -v $GITHUB_WORKSPACE:/zap/wrk \
            ghcr.io/zaproxy/zaproxy:stable \
            zap-baseline.py \
              -t https://${{ env.APP_SERVICE_NAME }}.azurewebsites.net \
              -J report_json.json \
              -w report_md.md \
              -r report_html.html \
              -a || true   

      - name: Upload ZAP Report
        uses: actions/upload-artifact@v4
        with:
          name: zap-reports
          path: |
              report_html.html
              report_json.json
              report_md.md

      - name: Show Summary
        run: |
          echo "## OWASP ZAP Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f report_md.md ]; then
            FAIL_COUNT=$(grep -c "FAIL-" report_md.md || true)
            WARN_COUNT=$(grep -c "WARN-" report_md.md || true)
            INFO_COUNT=$(grep -c "INFO-" report_md.md || true)
            PASS_COUNT=$(grep -c "PASS-" report_md.md || true)

            echo "### 📊 Findings Overview" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            echo "| Severity | Count |" >> $GITHUB_STEP_SUMMARY
            echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| 🔴 **FAIL** | $FAIL_COUNT |" >> $GITHUB_STEP_SUMMARY
            echo "| 🟠 **WARN** | $WARN_COUNT |" >> $GITHUB_STEP_SUMMARY
            echo "| 🔵 **INFO** | $INFO_COUNT |" >> $GITHUB_STEP_SUMMARY
            echo "| 🟢 **PASS** | $PASS_COUNT |" >> $GITHUB_STEP_SUMMARY

            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### 🔍 Detailed Matches (Raw)" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            grep -E 'FAIL|WARN|INFO|ALERT' report_md.md || echo "No issues detected." >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            else
            echo "⚠️ report_md.md not found." >> $GITHUB_STEP_SUMMARY
            fi

            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Artifacts Generated:**" >> $GITHUB_STEP_SUMMARY
            echo "- report_html.html" >> $GITHUB_STEP_SUMMARY
            echo "- report_json.json" >> $GITHUB_STEP_SUMMARY
            echo "- report_md.md" >> $GITHUB_STEP_SUMMARY