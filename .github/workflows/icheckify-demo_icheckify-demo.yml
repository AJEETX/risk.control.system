name: Build, Scan and Deploy ASP.Net Core app to Azure Web App - icheckify-demo

on:
  push:
    branches:
      - icheckify-demo
  pull_request:
  workflow_dispatch:

permissions:
  id-token: write
  contents: read
  security-events: write

env:
  APP_SERVICE_NAME: "icheckify-demo"

jobs:

  # ---------------------------------------------------
  # 1️⃣ Code Scan Job
  # ---------------------------------------------------
  code-scan:
    uses: ./.github/workflows/code-scan.yml
    secrets: inherit

  # ---------------------------------------------------
  # 2️⃣   Build  .Net Core Application Job
  # ---------------------------------------------------
  build:
    name: Build .Net Core Application
    runs-on: windows-latest
    needs: unified-security-summary
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Set up .NET Core
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.x'

      - name: Build
        run: dotnet build --configuration Release
     
      - name: Publish
        run: dotnet publish -c Release -o "${{ env.DOTNET_ROOT }}/myapp"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: .net-app
          path: ${{ env.DOTNET_ROOT }}/myapp

      - name: Add Summary Output
        run: |
            echo "## Build Completed" >> $GITHUB_STEP_SUMMARY
            echo "The .NET application has been built and published successfully." >> $GITHUB_STEP_SUMMARY

  # ---------------------------------------------------
  # 3️⃣ Deploy to Azure Job
  # ---------------------------------------------------
  deploy:
    name: Deploy to Azure Web App
    runs-on: windows-latest
    needs: build
    environment:
      name: Production
      url: ${{ steps.deploy-to-webapp.outputs.webapp-url }}
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: .net-app

      - name: Login to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZUREAPPSERVICE_CLIENTID_E49A1F04F52D44D39728428E2989E9BC }}
          tenant-id: ${{ secrets.AZUREAPPSERVICE_TENANTID_81F341426C9D455693B985BCD1A74409 }}
          subscription-id: ${{ secrets.AZUREAPPSERVICE_SUBSCRIPTIONID_1D866738C4B2423B95789A7662FDC228 }}

      - name: Deploy to Azure Web App
        id: deploy-to-webapp
        uses: azure/webapps-deploy@v3
        with:
          app-name: '${{ env.APP_SERVICE_NAME }}'
          slot-name: 'Production'
          package: .
 
      - name: Add Deployment Summary Output
        run: |
            echo "## Deployment Completed" >> $GITHUB_STEP_SUMMARY
            echo "The application has been deployed to Azure Web App successfully." >> $GITHUB_STEP_SUMMARY

  # ---------------------------------------------------
  # 4️⃣ Warmup Job
  # ---------------------------------------------------
  warmup:
    name: Warm Up Azure Web App
    runs-on: ubuntu-latest
    needs: deploy

    steps:
    - name: Wait for App Service warmup
      shell: bash
      run: |
        echo "🌐 Waiting for App Service to be ready..."
        URL="https://${{ env.APP_SERVICE_NAME }}.azurewebsites.net/Account/Login"

        for i in {1..20}; do
          STATUS=$(curl -o /dev/null -s -w "%{http_code}\n" "$URL" || echo 000)

          echo "Attempt $i → Status: $STATUS"

          if [ "$STATUS" -eq 200 ] || [ "$STATUS" -eq 302 ]; then
            echo "✅ App is ready!"
            exit 0
          fi

          echo "⏳ Not ready, waiting 15s..."
          sleep 15
        done

        echo "❌ App did NOT become ready in time."
        exit 1

    - name: Add Warm-up Summary Output
      if: always()
      run: |
        echo "## App Service Warmup Completed" >> $GITHUB_STEP_SUMMARY
        echo "The Azure Web App warm-up job has finished." >> $GITHUB_STEP_SUMMARY

  # ---------------------------------------------------
  # 5️⃣ OWASP ZAP Baseline Scan Job
  # ---------------------------------------------------
  zap-scan:
    name: OWASP ZAP Baseline Scan
    needs: warmup
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Fix permissions
        run: sudo chmod -R 777 $GITHUB_WORKSPACE

      - name: Run ZAP Baseline (Direct Docker)
        run: |
          docker run --network=host \
            -v $GITHUB_WORKSPACE:/zap/wrk \
            ghcr.io/zaproxy/zaproxy:stable \
            zap-baseline.py \
              -t https://${{ env.APP_SERVICE_NAME }}.azurewebsites.net \
              -J report_json.json \
              -w report_md.md \
              -r report_html.html \
              -a || true   

      - name: Upload ZAP Report
        uses: actions/upload-artifact@v4
        with:
          name: zap-reports
          path: |
              report_html.html
              report_json.json
              report_md.md

      - name: Show Summary
        run: |
          echo "## OWASP ZAP Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f report_md.md ]; then
            FAIL_COUNT=$(grep -c "FAIL-" report_md.md || true)
            WARN_COUNT=$(grep -c "WARN-" report_md.md || true)
            INFO_COUNT=$(grep -c "INFO-" report_md.md || true)
            PASS_COUNT=$(grep -c "PASS-" report_md.md || true)

            echo "### 📊 Findings Overview" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            echo "| Severity | Count |" >> $GITHUB_STEP_SUMMARY
            echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| 🔴 **FAIL** | $FAIL_COUNT |" >> $GITHUB_STEP_SUMMARY
            echo "| 🟠 **WARN** | $WARN_COUNT |" >> $GITHUB_STEP_SUMMARY
            echo "| 🔵 **INFO** | $INFO_COUNT |" >> $GITHUB_STEP_SUMMARY
            echo "| 🟢 **PASS** | $PASS_COUNT |" >> $GITHUB_STEP_SUMMARY

            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### 🔍 Detailed Matches (Raw)" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            grep -E 'FAIL|WARN|INFO|ALERT' report_md.md || echo "No issues detected." >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            else
            echo "⚠️ report_md.md not found." >> $GITHUB_STEP_SUMMARY
            fi

            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Artifacts Generated:**" >> $GITHUB_STEP_SUMMARY
            echo "- report_html.html" >> $GITHUB_STEP_SUMMARY
            echo "- report_json.json" >> $GITHUB_STEP_SUMMARY
            echo "- report_md.md" >> $GITHUB_STEP_SUMMARY